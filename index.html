<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>A&G Assistant</title>
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans antialiased h-screen flex flex-col">

    <div class="bg-white shadow-sm p-4 text-center font-bold text-lg flex justify-between items-center z-10">
        <span>A&G Assistant</span>
        <select id="userToggle" class="bg-gray-200 rounded px-2 py-1 text-sm font-semibold" onchange="handleUserChange()">
            <option value="Alex">Alex</option>
            <option value="Gen">Gen</option>
        </select>
    </div>

    <div id="content" class="flex-1 overflow-y-auto p-4 pb-20">
        
        <div id="screen-categories">
            <div class="flex justify-between items-center mb-2">
                <h2 class="font-bold text-gray-500 uppercase text-sm">Categories</h2>
                <button onclick="showScreen('add-exercise')" class="text-orange-500 text-sm font-bold">+ Add New</button>
            </div>
            <div id="categoryList" class="bg-white rounded-xl shadow-sm divide-y divide-gray-100">
                <div class="p-4 text-center text-gray-400">Loading categories...</div>
            </div>
        </div>


        <div id="screen-exercises" class="hidden">
            <button onclick="showScreen('categories')" class="text-blue-500 font-semibold mb-4 flex items-center">
                <span>&larr; Back</span>
            </button>
            <div class="flex justify-between items-center mb-2">
                <h2 id="categoryTitle" class="font-bold text-gray-500 uppercase text-sm">Workouts</h2>
                <div class="flex items-center space-x-4">
                    <label class="flex items-center text-xs font-semibold text-gray-400 cursor-pointer">
                        <input type="checkbox" id="showInactiveCheck" onchange="openCategory(document.getElementById('categoryTitle').textContent)" class="mr-1"> Show Inactive
                    </label>
                    <button onclick="showScreen('add-exercise')" class="text-orange-500 text-sm font-bold">+ Add New</button>
                </div>
            </div>
            <div id="exerciseList" class="bg-white rounded-xl shadow-sm divide-y divide-gray-100"></div>
        </div>


        <div id="screen-logger" class="hidden">
            <button onclick="showScreen('exercises')" class="text-blue-500 font-semibold mb-4 flex items-center">
                <span>&larr; Back</span>
            </button>
            <h1 id="loggerTitle" class="text-2xl font-bold mb-4">Exercise</h1>
            
            <img id="gifViewer" class="w-full max-h-48 object-contain bg-gray-50 rounded-xl mb-4 hidden" src="" alt="Exercise GIF">
            
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <h3 class="font-bold text-gray-800 text-sm mb-1">Session History</h3>
                <p id="lastSessionText" class="text-gray-600 text-sm">Loading...</p>
                <p id="prText" class="text-green-600 text-xs font-bold mt-1 hidden">Last increase: <span id="increaseDate"></span></p>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
                <div id="input-sets" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Sets</label>
                    <input type="number" id="sets" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none" placeholder="0">
                </div>
                <div id="input-reps" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Reps</label>
                    <input type="number" id="reps" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none" placeholder="0">
                </div>
                <div id="input-weight" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Weight (kg)</label>
                    <input type="number" id="weight" step="0.5" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none" placeholder="0">
                </div>
                <div id="input-time" class="hidden relative">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Time (seconds)</label>
                    <div class="flex items-center">
                        <input type="number" id="time" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none" placeholder="60">
                        <button id="timerBtn" onclick="toggleTimer()" class="ml-4 bg-green-500 text-white px-4 py-1 rounded-full text-sm font-bold">Start</button>
                    </div>
                    <div id="countdownDisplay" class="text-center text-5xl font-bold text-orange-500 my-4 hidden">60</div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4 mb-2">
                <label class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer border-2 border-transparent transition-colors text-center" id="levelUpContainer">
                    <span class="font-bold text-gray-800 text-sm mb-3">üöÄ Level Up</span>
                    <input type="checkbox" id="levelUpCheck" onchange="toggleLevelUp()" class="w-6 h-6 accent-blue-600">
                </label>
                
                <label class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer border-2 border-transparent transition-colors text-center" id="inactiveContainer">
                    <span class="font-bold text-gray-800 text-sm mb-3">üí§ Inactive</span>
                    <input type="checkbox" id="inactiveCheck" onchange="toggleInactive()" class="w-6 h-6 accent-gray-500">
                </label>
            </div>

            <div class="h-16"></div>
            <div class="fixed bottom-[96px] left-4 right-4 z-20">
                <button id="submitBtn" onclick="submitWorkout()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-xl transition-all duration-150 active:scale-95 active:bg-blue-800 active:shadow-sm">
                    Log Workout
                </button>
            </div>
        </div>

        <div id="screen-history" class="hidden">
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <select id="historyExerciseToggle" class="w-full bg-gray-100 rounded p-2 mb-2 text-sm font-semibold" onchange="renderChart()">
                    <option value="">Select an exercise for chart...</option>
                </select>
                
                <div id="chartContainer" class="relative w-full h-48 hidden mt-2">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        
            <h2 class="font-bold text-gray-500 mb-2 uppercase text-sm">Recent Logs</h2>
            <div id="historyList" class="bg-white rounded-xl shadow-sm divide-y divide-gray-100"></div>
        </div>

        <div id="screen-add-exercise" class="hidden">
            <button onclick="showScreen('categories')" class="text-blue-500 font-semibold mb-4 flex items-center">
                <span>&larr; Back</span>
            </button>
            <h1 class="text-2xl font-bold mb-4 text-orange-600">New Exercise</h1>
            
            <div class="bg-white p-4 rounded-xl shadow-sm space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Exercise Name</label>
                    <input type="text" id="newExName" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none" placeholder="e.g. Hammer Curls">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Category</label>
                    <select id="newExCategory" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Track These Units:</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center space-x-2 p-2 border rounded text-sm">
                            <input type="checkbox" value="sets" class="unit-check" checked> <span>Sets</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 border rounded text-sm">
                            <input type="checkbox" value="reps" class="unit-check" checked> <span>Reps</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 border rounded text-sm">
                            <input type="checkbox" value="weight" class="unit-check" checked> <span>Weight</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 border rounded text-sm">
                            <input type="checkbox" value="time" class="unit-check"> <span>Time</span>
                        </label>
                    </div>
                </div>
            </div>

            <button id="addExBtn" onclick="saveNewExercise()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl mt-6 shadow-lg active:scale-95 transition-transform">
                Save to Exercises
            </button>
        </div>

    </div>

    <div class="bg-white border-t border-gray-200 flex justify-around p-3 pb-8 fixed bottom-0 w-full z-10">
        <button onclick="showScreen('categories')" class="flex flex-col items-center text-blue-600 w-1/2">
            <span class="text-2xl">üèÉ</span>
            <span class="text-xs font-semibold mt-1">Workout</span>
        </button>
        <button onclick="showScreen('history')" class="flex flex-col items-center text-gray-400 w-1/2" id="tabHistory">
            <span class="text-2xl">üïí</span>
            <span class="text-xs font-semibold mt-1">History</span>
        </button>
    </div>

    <script>
        const API_URL = "https://sheetdb.io/api/v1/jb1t5l576h532";
        let exercises = [];
        let historyData = [];
        let categories = [];
        let currentExercise = null;
        let timerInterval;
        let countdownValue = 0;
        let progressChartInstance = null;
        const dingSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");

        async function init() {
            await Promise.all([fetchExercises(), fetchHistory()]);
            renderCategories();
        }

        async function fetchExercises() {
            const res = await fetch(`${API_URL}?sheet=Exercises`);
            exercises = await res.json();
            categories = [...new Set(exercises.map(ex => ex.category))].sort();
        }

        async function fetchHistory() {
            const res = await fetch(API_URL);
            let rawData = await res.json();
            
            // Improved sorting for DD/MM/YYYY
            historyData = rawData.sort((a, b) => {
                const [dayA, monthA, yearA] = a.date.split('/');
                const [dayB, monthB, yearB] = b.date.split('/');
                return new Date(yearB, monthB - 1, dayB) - new Date(yearA, monthA - 1, dayA);
            });
        
            populateHistoryDropdown();
            renderHistory();
            renderChart();
        }

        function showScreen(screen) {
            // Added 'add-exercise' to the array so it hides properly
            ['categories', 'exercises', 'logger', 'history', 'add-exercise'].forEach(s => {
                document.getElementById(`screen-${s}`).classList.add('hidden');
            });
            document.getElementById(`screen-${screen}`).classList.remove('hidden');
            
            document.querySelectorAll('.fixed.bottom-0 button').forEach(btn => btn.classList.replace('text-blue-600', 'text-gray-400'));
            if(screen === 'categories' || screen === 'exercises' || screen === 'logger' || screen === 'add-exercise') {
                document.querySelectorAll('.fixed.bottom-0 button')[0].classList.replace('text-gray-400', 'text-blue-600');
            }
            if(screen === 'history') document.querySelectorAll('.fixed.bottom-0 button')[1].classList.replace('text-gray-400', 'text-blue-600');
        }

        function handleUserChange() {
            loadData();
            renderHistory();
            renderChart();
            // Changed innerText to textContent here as well
            if (!document.getElementById('screen-exercises').classList.contains('hidden')) {
                openCategory(document.getElementById('categoryTitle').textContent);
            }
        }

        function renderCategories() {
            const list = document.getElementById('categoryList');
            const dropdown = document.getElementById('newExCategory');
        
            // Update the main Category buttons
            list.innerHTML = categories.map(cat => `
                <div onclick='openCategory("${cat}")' class="p-4 flex justify-between items-center cursor-pointer active:bg-gray-50">
                    <span class="font-bold text-gray-800">${cat}</span>
                    <span class="text-gray-300">&rang;</span>
                </div>
            `).join('');
        
            // Update the "Add New" dropdown menu options
            dropdown.innerHTML = categories.map(cat => `
                <option value="${cat}">${cat}</option>
            `).join('');
        }
        
function openCategory(category) {
    document.getElementById('categoryTitle').innerText = category;
    renderExerciseList(category);
    showScreen('exercises');
}

function renderExerciseList(category) {
    const list = document.getElementById('exerciseList');
    const user = document.getElementById('userToggle').value.toLowerCase();
    const showInactive = document.getElementById('showInactiveCheck').checked;
    
    const filtered = exercises.filter(ex => ex.category === category);
    
    const htmlOutput = filtered.map(ex => {
// Forces whatever Google Sheets returns into lowercase before checking
        const isInactive = String(ex[`inactive_${user}`]).toLowerCase() === 'true';
        const isReady = String(ex[`levelup_${user}`]).toLowerCase() === 'true';
        
        if (isInactive && !showInactive) return '';

        const readyBadge = isReady ? `<span class="ml-2 text-[10px] bg-orange-100 text-orange-800 px-2 py-1 rounded-full font-bold uppercase tracking-wider">Up Next üöÄ</span>` : '';
        const inactiveBadge = isInactive ? `<span class="ml-2 text-[10px] bg-gray-200 text-gray-600 px-2 py-1 rounded-full font-bold uppercase tracking-wider">Inactive üí§</span>` : '';
        
        return `
        <div onclick='openLogger(${JSON.stringify(ex).replace(/'/g, "&apos;")})' class="p-4 flex justify-between items-center cursor-pointer active:bg-gray-50 ${isInactive ? 'opacity-50' : ''}">
            <div class="flex items-center">
                <span class="font-bold text-gray-800">${ex.name}</span>
                ${readyBadge}
                ${inactiveBadge}
            </div>
            <span class="text-gray-300">&rang;</span>
        </div>
        `;
    }).join('');

    list.innerHTML = htmlOutput || '<div class="p-4 text-center text-gray-400">No active exercises.</div>';
}
        
       function renderHistory() {
            const user = document.getElementById('userToggle').value;
            const selectedExercise = document.getElementById('historyExerciseToggle').value;
            const list = document.getElementById('historyList');
            
            // Filter by user AND optionally by the dropdown selection
            const filtered = historyData.filter(log => {
                const matchesUser = log.user_name === user;
                const matchesExercise = !selectedExercise || log.exercise_name === selectedExercise;
                return matchesUser && matchesExercise;
            });
            
            if (filtered.length === 0) return list.innerHTML = '<div class="p-4 text-center text-gray-400">No logs found.</div>';
            
            list.innerHTML = filtered.map(log => `
                <div class="p-4 flex justify-between items-center group">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-1 mr-4">
                            <span class="font-bold text-gray-800">${log.exercise_name}</span>
                            <span class="text-xs px-2 py-1 rounded bg-${log.user_name === 'Alex' ? 'green' : 'pink'}-100 text-${log.user_name === 'Alex' ? 'green' : 'pink'}-800 font-bold">${log.user_name}</span>
                        </div>
                        <div class="text-sm text-gray-600">${[log.sets ? log.sets+' Sets' : '', log.reps ? log.reps+' Reps' : '', log.weight ? log.weight+'kg' : '', log.time ? log.time+'s' : ''].filter(Boolean).join(' √ó ')}</div>
                        <div class="text-xs text-gray-400 mt-1">${log.date}</div>
                    </div>
                    <button onclick="deleteLog('${log.id}')" class="text-red-400 hover:text-red-600 p-2 text-xl">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        function populateHistoryDropdown() {
            const dropdown = document.getElementById('historyExerciseToggle');
            const uniqueExercises = [...new Set(historyData.map(log => log.exercise_name))].sort();
            dropdown.innerHTML = '<option value="">Select an exercise for chart...</option>' + 
                uniqueExercises.map(ex => `<option value="${ex}">${ex}</option>`).join('');
        }

        function renderChart() {
            const user = document.getElementById('userToggle').value;
            const exerciseName = document.getElementById('historyExerciseToggle').value;
            const canvas = document.getElementById('progressChart');
            const container = document.getElementById('chartContainer');
            
            // Update the history list below the chart
            renderHistory();
            
            if (!exerciseName) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            const chartLogs = historyData.filter(log => log.exercise_name === exerciseName && log.user_name === user).reverse();
            const labels = chartLogs.map(log => log.date);
            const data = chartLogs.map(log => parseFloat(log.weight) || parseFloat(log.time) || 0);
            
            if (progressChartInstance) progressChartInstance.destroy();
            
            progressChartInstance = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: exerciseName,
                        data: data,
                        borderColor: user === 'Alex' ? '#10B981' : '#EC4899', 
                        backgroundColor: user === 'Alex' ? '#D1FAE5' : '#FCE7F3',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function openLogger(ex) {
            currentExercise = ex;
            document.getElementById('loggerTitle').innerText = ex.name;
            
            const gif = document.getElementById('gifViewer');
            if(ex.gif_url) { gif.src = ex.gif_url; gif.classList.remove('hidden'); }
            else { gif.classList.add('hidden'); }

            const units = ex.units ? ex.units.toLowerCase() : "sets,reps,weight";
            const isCardio = ex.category === "Cardio";
            
            ['sets', 'reps', 'weight', 'time'].forEach(u => {
                const container = document.getElementById(`input-${u}`);
                container.classList.toggle('hidden', !units.includes(u));
                
                if (u === 'time') {
                    container.querySelector('label').innerText = isCardio ? "Time (minutes)" : "Time (seconds)";
                }
            });

            loadData();
            showScreen('logger');
        }

        function loadData() {
            if(!currentExercise) return;
            const user = document.getElementById('userToggle').value;
            const userLogs = historyData.filter(l => l.exercise_name === currentExercise.name && l.user_name === user);
            const last = userLogs[0];
            const units = currentExercise.units ? currentExercise.units.toLowerCase() : "";
        
            if(last) {
                document.getElementById('sets').value = last.sets || '';
                document.getElementById('reps').value = last.reps || '';
                document.getElementById('weight').value = last.weight || '';
                document.getElementById('time').value = last.time || '';
                
            let details = [
                last.sets ? last.sets+' Sets' : '', 
                last.reps ? last.reps+' Reps' : '', 
                last.weight ? last.weight+'kg' : '', 
                last.time ? (currentExercise.category === "Cardio" ? last.time+'m' : last.time+'s') : ''
            ].filter(Boolean).join(' √ó ');
        
            // Adds the date right before the stats
            document.getElementById('lastSessionText').innerText = `${last.date}: ${details}`;
        
                let incDate = null;
                for(let i=0; i<userLogs.length-1; i++) {
                    let increased = false;
                    
                    if (units.includes('weight')) {
                        increased = parseFloat(userLogs[i].weight) > parseFloat(userLogs[i+1].weight);
                    } else if (units.includes('time')) {
                        increased = parseFloat(userLogs[i].time) > parseFloat(userLogs[i+1].time);
                    } else if (units.includes('reps')) {
                        increased = parseFloat(userLogs[i].reps) > parseFloat(userLogs[i+1].reps);
                    }
        
                    if(increased) { incDate = userLogs[i].date; break; }
                }
        
                const prText = document.getElementById('prText');
                if(incDate) { 
                    prText.classList.remove('hidden'); 
                    document.getElementById('increaseDate').innerText = incDate; 
                } else { 
                    prText.classList.add('hidden'); 
                }
            } else {
                ['sets', 'reps', 'weight', 'time'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('lastSessionText').innerText = "No previous data.";
                document.getElementById('prText').classList.add('hidden');
            }
         // Sync Toggles from Google Sheet data
    const userLower = user.toLowerCase();
    const isReady = String(currentExercise[`levelup_${userLower}`]).toLowerCase() === 'true';
    const isInactive = String(currentExercise[`inactive_${userLower}`]).toLowerCase() === 'true';

    document.getElementById('levelUpCheck').checked = isReady;
    document.getElementById('inactiveCheck').checked = isInactive;

    // Update container borders
    const levelContainer = document.getElementById('levelUpContainer');
    if (isReady) levelContainer.classList.replace('border-transparent', 'border-blue-500');
    else levelContainer.classList.replace('border-blue-500', 'border-transparent');

    const inactiveContainer = document.getElementById('inactiveContainer');
    if (isInactive) inactiveContainer.classList.replace('border-transparent', 'border-gray-400');
    else inactiveContainer.classList.replace('border-gray-400', 'border-transparent');
        }

        function toggleTimer() {
            const btn = document.getElementById('timerBtn');
            const display = document.getElementById('countdownDisplay');
            const isCardio = currentExercise.category === "Cardio";
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                btn.innerText = "Start";
                btn.classList.replace('bg-red-500', 'bg-green-500');
                display.classList.add('hidden');
            } else {
                let rawValue = parseInt(document.getElementById('time').value) || 0;
                countdownValue = isCardio ? rawValue * 60 : rawValue; 
                
                if(countdownValue <= 0) return;    
                
                display.classList.remove('hidden');
                display.innerText = countdownValue;
                display.classList.replace('text-red-500', 'text-orange-500');
                btn.innerText = "Stop";
                btn.classList.replace('bg-green-500', 'bg-red-500');

                timerInterval = setInterval(() => {
                    countdownValue--;
                    display.innerText = countdownValue;
                    if(countdownValue <= 5) display.classList.replace('text-orange-500', 'text-red-500');
                    if(countdownValue <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        btn.innerText = "Start";
                        btn.classList.replace('bg-red-500', 'bg-green-500');
                        dingSound.play().catch(e => console.log("Audio play prevented by browser"));
                    }
                }, 1000);
            }
        }

        async function submitWorkout() {
            const btn = document.getElementById('submitBtn');
            const user = document.getElementById('userToggle').value;
            const currentDate = new Date().toLocaleDateString('en-GB');
            const userLogs = historyData.filter(l => l.exercise_name === currentExercise.name && l.user_name === user);
    
            // Check if a log already exists for today
            const alreadyLogged = userLogs.some(l => l.date === currentDate);
            if (alreadyLogged) {
                const proceed = confirm(`You already logged ${currentExercise.name} today. Are you sure you want to log it again?`);
                if (!proceed) return; // Stop the save if they click Cancel
            }
    
            btn.innerText = "Saving...";
            btn.disabled = true;
        
            const weightVal = parseFloat(document.getElementById('weight').value) || 0;
            const repsVal = parseFloat(document.getElementById('reps').value) || 0;
            const timeVal = parseFloat(document.getElementById('time').value) || 0;
            
            const units = currentExercise.units ? currentExercise.units.toLowerCase() : "";
        
            const bestWeight = Math.max(0, ...userLogs.map(l => parseFloat(l.weight) || 0));
            const bestReps = Math.max(0, ...userLogs.map(l => parseFloat(l.reps) || 0));
            const bestTime = Math.max(0, ...userLogs.map(l => parseFloat(l.time) || 0));
        
            let isPR = false;
        
            if (units.includes('weight') && weightVal > 0) {
                isPR = weightVal > bestWeight && bestWeight > 0;
            } else if (units.includes('time') && timeVal > 0) {
                isPR = timeVal > bestTime && bestTime > 0;
            } else if (units.includes('reps') && repsVal > 0) {
                isPR = repsVal > bestReps && bestReps > 0;
            }
        
            const log = {
                id: crypto.randomUUID(),
                exercise_name: currentExercise.name,
                category: currentExercise.category,
                user_name: user,
                date: new Date().toLocaleDateString('en-GB'), 
                sets: document.getElementById('sets').value,
                reps: document.getElementById('reps').value,
                weight: document.getElementById('weight').value,
                time: document.getElementById('time').value
            };
        
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [log] })
                });
            // After successfully logging the workout:
        if (isPR) {
            confetti({ 
                particleCount: 150, 
                spread: 70, 
                origin: { y: 0.6 },
                colors: user === 'Alex' ? ['#10B981', '#ffffff'] : ['#EC4899', '#ffffff'] 
            });

            // AUTO-RESET: Since you hit a PR, you've "Leveled Up"!
            // We tell the Exercise sheet to set your levelup status to false.
            const userLower = user.toLowerCase();
            const levelUpColumn = `levelup_${userLower}`;
            
            try {
                await fetch(`${API_URL}/id/${currentExercise.id}?sheet=Exercises`, {
                    method: 'PATCH',
                    headers: { 
                        'Accept': 'application/json',
                        'Content-Type': 'application/json' 
                    },
                    // THE FIX: Added the "data" wrapper here as well
                    body: JSON.stringify({ data: { [levelUpColumn]: "false" } })
                });
                
                await fetchExercises(); 
            } catch (err) {
                console.error("Auto-reset failed:", err);
            }

            await new Promise(r => setTimeout(r, 2000));
        }
        
                await fetchHistory(); 
                // Don't leave the page, just reload the data
                loadData();
            } catch (err) { 
                alert("Failed to save log."); 
            }
        
            btn.innerText = "Log Workout";
            btn.disabled = false;
        }
        
        async function deleteLog(logId) {
    if (!confirm("Are you sure you want to delete this log?")) return;

    try {
        // SheetDB allows deleting by column value
        const res = await fetch(`${API_URL}/id/${logId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });

        if (res.ok) {
            // Refresh local data so the UI updates immediately
            await fetchHistory();
            alert("Log deleted successfully.");
        }
    } catch (err) {
        alert("Failed to delete log.");
    }
}
async function updateExerciseState(type, isChecked) {
    const user = document.getElementById('userToggle').value.toLowerCase();
    const column = `${type}_${user}`; 
    
    const containerId = type === 'levelup' ? 'levelUpContainer' : 'inactiveContainer';
    const activeColor = type === 'levelup' ? 'border-blue-500' : 'border-gray-400';
    const container = document.getElementById(containerId);
    
    if (isChecked) {
        container.classList.replace('border-transparent', activeColor);
    } else {
        container.classList.replace(activeColor, 'border-transparent');
    }

    try {
        await fetch(`${API_URL}/id/${currentExercise.id}?sheet=Exercises`, {
            method: 'PATCH',
            headers: { 
                'Accept': 'application/json',
                'Content-Type': 'application/json' 
            },
            // THE FIX: SheetDB requires the "data" wrapper
            body: JSON.stringify({ data: { [column]: isChecked ? "true" : "false" } })
        });
        
        await fetchExercises();
        if (currentExercise && currentExercise.category) {
            renderExerciseList(currentExercise.category);
        }
    } catch (err) {
        console.error("Failed to sync with Google Sheets:", err);
    }
}

// Update these wrappers to use the new function
function toggleLevelUp() {
    updateExerciseState('levelup', document.getElementById('levelUpCheck').checked);
}

function toggleInactive() {
    updateExerciseState('inactive', document.getElementById('inactiveCheck').checked);
}
        async function saveNewExercise() {
            const btn = document.getElementById('addExBtn');
            const name = document.getElementById('newExName').value;
            const category = document.getElementById('newExCategory').value;
            const selectedUnits = Array.from(document.querySelectorAll('.unit-check:checked')).map(cb => cb.value).join(',');

            if (!name) return alert("Please enter a name.");

            btn.innerText = "Adding...";
            btn.disabled = true;

            const newExercise = {
                id: crypto.randomUUID(),
                name: name,
                category: category,
                units: selectedUnits,
                gif_url: ""
            };

            try {
                const res = await fetch(`${API_URL}?sheet=Exercises`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [newExercise] })
                });

                if (res.ok) {
                    alert(`${name} added!`);
                    document.getElementById('newExName').value = ""; 
                    await fetchExercises(); 
                    renderCategories(); 
                    showScreen('categories');
                }
            } catch (err) {
                alert("Error adding exercise.");
            }

            btn.innerText = "Save to Exercises";
            btn.disabled = false;
        }

        init(); 
    </script>
</body>
</html>
