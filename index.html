<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>A&G Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Prevents zooming and bounce effects to feel like a native app */
        body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans antialiased h-screen flex flex-col">

    <div class="bg-white shadow-sm p-4 text-center font-bold text-lg flex justify-between items-center z-10">
        <span>A&G Assistant</span>
        <select id="userToggle" class="bg-gray-200 rounded px-2 py-1 text-sm font-semibold" onchange="loadData()">
            <option value="Alex">Alex</option>
            <option value="Gen">Gen</option>
        </select>
    </div>

    <div id="content" class="flex-1 overflow-y-auto p-4 pb-20">
        
        <div id="screen-exercises">
            <h2 class="font-bold text-gray-500 mb-2 uppercase text-sm">Workouts</h2>
            <div id="exerciseList" class="bg-white rounded-xl shadow-sm divide-y divide-gray-100">
                <div class="p-4 text-center text-gray-400">Loading exercises...</div>
            </div>
        </div>

        <div id="screen-logger" class="hidden">
            <button onclick="showScreen('exercises')" class="text-blue-500 font-semibold mb-4 flex items-center">
                <span>&larr; Back</span>
            </button>
            <h1 id="loggerTitle" class="text-2xl font-bold mb-4">Exercise</h1>
            
            <img id="gifViewer" class="w-full h-48 object-cover rounded-xl mb-4 hidden" src="" alt="Exercise GIF">
            
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <h3 class="font-bold text-gray-800 text-sm mb-1">Session History</h3>
                <p id="lastSessionText" class="text-gray-600 text-sm">Loading...</p>
                <p id="prText" class="text-green-600 text-xs font-bold mt-1 hidden">Last increase: <span id="increaseDate"></span></p>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm space-y-3">
                <div id="input-sets" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Sets</label>
                    <input type="number" id="sets" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none" placeholder="0">
                </div>
                <div id="input-reps" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Reps</label>
                    <input type="number" id="reps" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none" placeholder="0">
                </div>
                <div id="input-weight" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Weight (kg)</label>
                    <input type="number" id="weight" step="0.5" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none" placeholder="0">
                </div>
                <div id="input-time" class="hidden relative">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Time (seconds)</label>
                    <div class="flex items-center">
                        <input type="number" id="time" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none" placeholder="60">
                        <button id="timerBtn" onclick="toggleTimer()" class="ml-4 bg-green-500 text-white px-4 py-1 rounded-full text-sm font-bold">Start</button>
                    </div>
                    <div id="countdownDisplay" class="text-center text-5xl font-bold text-orange-500 my-4 hidden">60</div>
                </div>
            </div>

            <button id="submitBtn" onclick="submitWorkout()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mt-6">
                Log Workout
            </button>
        </div>

        <div id="screen-history" class="hidden">
            <h2 class="font-bold text-gray-500 mb-2 uppercase text-sm">Recent Logs</h2>
            <div id="historyList" class="bg-white rounded-xl shadow-sm divide-y divide-gray-100">
                <div class="p-4 text-center text-gray-400">Loading history...</div>
            </div>
        </div>

    </div>

    <div class="bg-white border-t border-gray-200 flex justify-around p-3 pb-8 fixed bottom-0 w-full z-10">
        <button onclick="showScreen('exercises')" class="flex flex-col items-center text-blue-600 w-1/2">
            <span class="text-2xl">üèÉ</span>
            <span class="text-xs font-semibold mt-1">Workout</span>
        </button>
        <button onclick="showScreen('history')" class="flex flex-col items-center text-gray-400 w-1/2" id="tabHistory">
            <span class="text-2xl">üïí</span>
            <span class="text-xs font-semibold mt-1">History</span>
        </button>
    </div>

    <script>
        const API_URL = "https://sheetdb.io/api/v1/jb1t5l576h532";
        let exercises = [];
        let historyData = [];
        let currentExercise = null;
        let timerInterval;
        let countdownValue = 0;
        const dingSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");

        async function init() {
            await Promise.all([fetchExercises(), fetchHistory()]);
            renderExercises();
        }

        async function fetchExercises() {
            const res = await fetch(`${API_URL}?sheet=Exercises`);
            exercises = await res.json();
        }

        async function fetchHistory() {
            const res = await fetch(API_URL);
            historyData = (await res.json()).reverse();
            renderHistory();
        }

        function showScreen(screen) {
            document.getElementById('screen-exercises').classList.add('hidden');
            document.getElementById('screen-logger').classList.add('hidden');
            document.getElementById('screen-history').classList.add('hidden');
            document.getElementById(`screen-${screen}`).classList.remove('hidden');
            
            // Tab styling update
            document.querySelectorAll('.fixed.bottom-0 button').forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-400');
            });
            if(screen === 'exercises' || screen === 'logger') document.querySelectorAll('.fixed.bottom-0 button')[0].classList.add('text-blue-600', 'text-gray-400');
            if(screen === 'history') document.querySelectorAll('.fixed.bottom-0 button')[1].classList.add('text-blue-600', 'text-gray-400');
        }

        function renderExercises() {
            const list = document.getElementById('exerciseList');
            list.innerHTML = exercises.map(ex => `
                <div onclick='openLogger(${JSON.stringify(ex)})' class="p-4 flex justify-between items-center cursor-pointer active:bg-gray-50">
                    <div>
                        <div class="font-bold text-gray-800">${ex.name}</div>
                        <div class="text-xs text-gray-400">${ex.category}</div>
                    </div>
                    <span class="text-gray-300">&rang;</span>
                </div>
            `).join('');
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if (historyData.length === 0) return list.innerHTML = '<div class="p-4 text-center">No logs yet.</div>';
            list.innerHTML = historyData.map(log => `
                <div class="p-4">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-gray-800">${log.exercise_name}</span>
                        <span class="text-xs px-2 py-1 rounded bg-${log.user_name === 'Alex' ? 'green' : 'blue'}-100 text-${log.user_name === 'Alex' ? 'green' : 'blue'}-800 font-bold">${log.user_name}</span>
                    </div>
                    <div class="text-sm text-gray-600">${[log.sets ? log.sets+' Sets' : '', log.reps ? log.reps+' Reps' : '', log.weight ? log.weight+'kg' : '', log.time ? log.time+'s' : ''].filter(Boolean).join(' √ó ')}</div>
                    <div class="text-xs text-gray-400 mt-1">${log.date}</div>
                </div>
            `).join('');
        }

        function openLogger(ex) {
            currentExercise = ex;
            document.getElementById('loggerTitle').innerText = ex.name;
            
            // Handle GIF
            const gif = document.getElementById('gifViewer');
            if(ex.gif_url) { gif.src = ex.gif_url; gif.classList.remove('hidden'); }
            else { gif.classList.add('hidden'); }

            // Handle Units
            const units = ex.units ? ex.units.toLowerCase() : "sets,reps,weight";
            ['sets', 'reps', 'weight', 'time'].forEach(u => {
                document.getElementById(`input-${u}`).classList.toggle('hidden', !units.includes(u));
            });

            loadData();
            showScreen('logger');
        }

        function loadData() {
            if(!currentExercise) return;
            const user = document.getElementById('userToggle').value;
            const userLogs = historyData.filter(l => l.exercise_name === currentExercise.name && l.user_name === user);
            const last = userLogs[0];

            if(last) {
                document.getElementById('sets').value = last.sets || '';
                document.getElementById('reps').value = last.reps || '';
                document.getElementById('weight').value = last.weight || '';
                document.getElementById('time').value = last.time || '';
                
                let details = [last.sets ? last.sets+' Sets' : '', last.reps ? last.reps+' Reps' : '', last.weight ? last.weight+'kg' : '', last.time ? last.time+'s' : ''].filter(Boolean).join(' √ó ');
                document.getElementById('lastSessionText').innerText = details;

                // Increase Logic
                let incDate = null;
                for(let i=0; i<userLogs.length-1; i++) {
                    if(parseFloat(userLogs[i].weight) > parseFloat(userLogs[i+1].weight)) { incDate = userLogs[i].date; break; }
                }
                const prText = document.getElementById('prText');
                if(incDate) { prText.classList.remove('hidden'); document.getElementById('increaseDate').innerText = incDate; }
                else { prText.classList.add('hidden'); }
            } else {
                ['sets', 'reps', 'weight', 'time'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('lastSessionText').innerText = "No previous data.";
                document.getElementById('prText').classList.add('hidden');
            }
        }

        function toggleTimer() {
            const btn = document.getElementById('timerBtn');
            const display = document.getElementById('countdownDisplay');
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                btn.innerText = "Start";
                btn.classList.replace('bg-red-500', 'bg-green-500');
                display.classList.add('hidden');
            } else {
                countdownValue = parseInt(document.getElementById('time').value) || 0;
                if(countdownValue <= 0) return;
                
                display.classList.remove('hidden');
                display.innerText = countdownValue;
                display.classList.replace('text-red-500', 'text-orange-500');
                btn.innerText = "Stop";
                btn.classList.replace('bg-green-500', 'bg-red-500');

                timerInterval = setInterval(() => {
                    countdownValue--;
                    display.innerText = countdownValue;
                    if(countdownValue <= 5) display.classList.replace('text-orange-500', 'text-red-500');
                    if(countdownValue <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        btn.innerText = "Start";
                        btn.classList.replace('bg-red-500', 'bg-green-500');
                        dingSound.play().catch(e => console.log("Audio play prevented by browser"));
                    }
                }, 1000);
            }
        }

        async function submitWorkout() {
            const btn = document.getElementById('submitBtn');
            btn.innerText = "Saving...";
            btn.disabled = true;

            const user = document.getElementById('userToggle').value;
            const weightVal = document.getElementById('weight').value;
            
            const userLogs = historyData.filter(l => l.exercise_name === currentExercise.name && l.user_name === user);
            const bestWeight = Math.max(0, ...userLogs.map(l => parseFloat(l.weight) || 0));
            const isPR = parseFloat(weightVal) > bestWeight && bestWeight > 0;

            const log = {
                id: crypto.randomUUID(),
                exercise_name: currentExercise.name,
                category: currentExercise.category,
                user_name: user,
                date: new Date().toLocaleDateString(),
                sets: document.getElementById('sets').value,
                reps: document.getElementById('reps').value,
                weight: weightVal,
                time: document.getElementById('time').value
            };

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [log] })
                });

                if (isPR) {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    await new Promise(r => setTimeout(r, 2000));
                }

                await fetchHistory(); // Refresh
                showScreen('exercises');
            } catch (err) { alert("Failed to save log."); }

            btn.innerText = "Log Workout";
            btn.disabled = false;
        }

        init(); // Start app
    </script>
</body>
</html>
