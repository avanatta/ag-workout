<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>A&G Assistant</title>
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans antialiased h-screen flex flex-col">

    <div class="bg-white shadow-sm p-4 text-center font-bold text-lg flex justify-between items-center z-10">
        <span>A&G Assistant</span>
        <select id="userToggle" class="bg-gray-200 rounded px-2 py-1 text-sm font-semibold" onchange="handleUserChange()">
            <option value="Alex">Alex</option>
            <option value="Gen">Gen</option>
        </select>
    </div>

    <div id="content" class="flex-1 overflow-y-auto p-4 pb-20">
        
        <div id="screen-categories">
            <div class="flex justify-between items-center mb-2">
                <h2 class="font-bold text-gray-500 uppercase text-sm">Categories</h2>
                </div>
            <div id="categoryList" class="bg-white rounded-xl shadow-sm divide-y divide-gray-100">
                <div class="p-4 text-center text-gray-400">Loading categories...</div>
            </div>
            
            <button onclick="showScreen('add-exercise')" class="fixed bottom-[104px] right-6 w-14 h-14 bg-orange-500 text-white rounded-full shadow-xl flex items-center justify-center text-4xl font-light pb-1 active:scale-95 transition-transform z-20">
                +
            </button>
        </div>

        <div id="screen-exercises" class="hidden">
            <button onclick="showScreen('categories')" class="text-blue-500 font-semibold mb-4 flex items-center">
                <span>&larr; Back</span>
            </button>
            <div class="flex justify-between items-center mb-2">
                <h2 id="categoryTitle" class="font-bold text-gray-500 uppercase text-sm">Workouts</h2>
                <div class="flex items-center space-x-4">
                    <label class="flex items-center text-xs font-semibold text-gray-400 cursor-pointer">
                        <input type="checkbox" id="showInactiveCheck" onchange="openCategory(document.getElementById('categoryTitle').textContent)" class="mr-1"> Show Inactive
                    </label>
                    </div>
            </div>
            <div id="exerciseList" class="bg-white rounded-xl shadow-sm divide-y divide-gray-100"></div>

            <button onclick="showScreen('add-exercise')" class="fixed bottom-[104px] right-6 w-14 h-14 bg-orange-500 text-white rounded-full shadow-xl flex items-center justify-center text-4xl font-light pb-1 active:scale-95 transition-transform z-20">
                +
            </button>
        </div>

        <div id="screen-logger" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <button onclick="showScreen('exercises')" class="text-blue-500 font-semibold flex items-center">
                    <span class="text-xl mr-1">&larr;</span> Back
                </button>
                <h1 id="loggerTitle" class="text-xl font-bold text-gray-900 truncate ml-4 flex-1 text-right">Exercise</h1>
            </div>

            <img id="gifViewer" class="w-full max-h-48 object-contain bg-gray-50 rounded-xl mb-4 hidden" src="" alt="Exercise GIF">
            
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <div class="flex justify-between items-center cursor-pointer" onclick="toggleLoggerChart()">
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800 text-sm mb-1">Session History</h3>
                        <p id="lastSessionText" class="text-gray-600 text-sm">Loading...</p>
                        <p id="prText" class="text-green-600 text-xs font-bold mt-1 hidden">Last increase: <span id="increaseDate"></span></p>
                    </div>
                    <div id="chartToggleIcon" class="text-gray-400 text-2xl transition-transform duration-300 hidden">‚ñæ</div>
                </div>
                
                <div id="loggerChartContainer" class="hidden mt-4 pt-4 border-t border-gray-100 relative w-full h-32">
                    <canvas id="loggerChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <div class="grid grid-cols-2 gap-x-6 gap-y-4">
                    <div id="input-sets" class="hidden">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Sets</label>
                        <input type="number" id="sets" class="w-full border-b-2 border-gray-100 p-1 text-xl font-semibold focus:outline-none focus:border-blue-500 transition-colors" placeholder="0">
                    </div>
                    <div id="input-reps" class="hidden">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Reps</label>
                        <input type="number" id="reps" class="w-full border-b-2 border-gray-100 p-1 text-xl font-semibold focus:outline-none focus:border-blue-500 transition-colors" placeholder="0">
                    </div>
                    <div id="input-weight" class="hidden">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Weight (kg)</label>
                        <input type="number" id="weight" step="0.5" class="w-full border-b-2 border-gray-100 p-1 text-xl font-semibold focus:outline-none focus:border-blue-500 transition-colors" placeholder="0">
                    </div>
                    <div id="input-time" class="hidden">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Time</label>
                        <div class="flex items-center space-x-2">
                            <input type="number" id="time" class="w-full border-b-2 border-gray-100 p-1 text-xl font-semibold focus:outline-none focus:border-blue-500 transition-colors" placeholder="0">
                            <button id="timerBtn" onclick="toggleTimer()" class="bg-green-500 text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase w-16 text-center transition-colors">Start</button>
                            <button id="resetTimerBtn" onclick="resetTimer()" class="bg-gray-200 text-gray-600 px-3 py-1 rounded-lg text-[10px] font-bold uppercase hidden transition-colors">Reset</button>
                        </div>
                    </div>
                </div>
                <div id="countdownDisplay" class="text-center text-5xl font-bold text-orange-500 mt-4 hidden">60</div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-4 mb-4">
                <label class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer border-2 border-transparent transition-colors text-center" id="levelUpContainer">
                    <span class="font-bold text-gray-800 text-sm mb-3">üöÄ Level Up</span>
                    <input type="checkbox" id="levelUpCheck" onchange="toggleLevelUp()" class="w-6 h-6 accent-blue-600">
                </label>
                
                <label class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center cursor-pointer border-2 border-transparent transition-colors text-center" id="inactiveContainer">
                    <span class="font-bold text-gray-800 text-sm mb-3">üí§ Inactive</span>
                    <input type="checkbox" id="inactiveCheck" onchange="toggleInactive()" class="w-6 h-6 accent-gray-500">
                </label>
            </div>

            <div class="h-16"></div>
            <div class="fixed bottom-[96px] left-4 right-4 z-20">
                <button id="submitBtn" onclick="submitWorkout()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-xl transition-all duration-150 active:scale-95 active:bg-blue-800 active:shadow-sm">
                    Log Workout
                </button>
            </div>
        </div>

        <div id="screen-history" class="hidden">
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <select id="historyExerciseToggle" class="w-full bg-gray-100 rounded p-2 mb-2 text-sm font-semibold" onchange="renderChart()">
                    <option value="">Select an exercise for chart...</option>
                </select>
                
                <div id="chartContainer" class="relative w-full h-48 hidden mt-2">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        
            <h2 class="font-bold text-gray-500 mb-2 uppercase text-sm">Recent Logs</h2>
            <div id="historyList" class="bg-white rounded-xl shadow-sm divide-y divide-gray-100"></div>
        </div>

        <div id="screen-add-exercise" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <button onclick="showScreen('categories')" class="text-blue-500 font-semibold flex items-center">
                    <span class="text-xl mr-1">&larr;</span> Back
                </button>
                <h1 class="text-xl font-bold text-orange-600 text-right">New Exercise</h1>
            </div>
            
            <div class="bg-white p-4 rounded-xl shadow-sm space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Exercise Name</label>
                    <input type="text" id="newExName" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none" placeholder="e.g. Hammer Curls">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Category</label>
                    <select id="newExCategory" class="w-full border-b border-gray-200 p-2 text-lg focus:outline-none bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Track These Units:</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center space-x-2 p-2 border rounded text-sm">
                            <input type="checkbox" value="sets" class="unit-check" checked> <span>Sets</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 border rounded text-sm">
                            <input type="checkbox" value="reps" class="unit-check" checked> <span>Reps</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 border rounded text-sm">
                            <input type="checkbox" value="weight" class="unit-check" checked> <span>Weight</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 border rounded text-sm">
                            <input type="checkbox" value="time" class="unit-check"> <span>Time</span>
                        </label>
                    </div>
                </div>
            </div>

            <button id="addExBtn" onclick="saveNewExercise()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl mt-6 shadow-lg active:scale-95 transition-transform">
                Save to Exercises
            </button>
        </div>

    </div>

    <div class="bg-white border-t border-gray-200 flex justify-around p-3 pb-8 fixed bottom-0 w-full z-10">
        <button onclick="showScreen('categories')" class="flex flex-col items-center text-blue-600 w-1/2">
            <span class="text-2xl">üèÉ</span>
            <span class="text-xs font-semibold mt-1">Workout</span>
        </button>
        <button onclick="showScreen('history')" class="flex flex-col items-center text-gray-400 w-1/2" id="tabHistory">
            <span class="text-2xl">üïí</span>
            <span class="text-xs font-semibold mt-1">History</span>
        </button>
    </div>

    <script>
        const API_URL = "https://sheetdb.io/api/v1/jb1t5l576h532";
        let exercises = [];
        let historyData = [];
        let categories = [];
        let currentExercise = null;
        let timerInterval;
        let countdownValue = 0;
        let progressChartInstance = null;
        let loggerChartInstance = null;
        const dingSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");

        async function init() {
            await Promise.all([fetchExercises(), fetchHistory()]);
            renderCategories();
        }

        async function fetchExercises() {
            const res = await fetch(`${API_URL}?sheet=Exercises`, { cache: 'no-store' });
            exercises = await res.json();
            categories = [...new Set(exercises.map(ex => ex.category))].sort();
        }

        async function fetchHistory() {
            const res = await fetch(API_URL);
            let rawData = await res.json();
            
            historyData = rawData.sort((a, b) => {
                const [dayA, monthA, yearA] = a.date.split('/');
                const [dayB, monthB, yearB] = b.date.split('/');
                return new Date(yearB, monthB - 1, dayB) - new Date(yearA, monthA - 1, dayA);
            });
        
            populateHistoryDropdown();
            renderHistory();
            renderChart();
        }

        function showScreen(screen) {
            ['categories', 'exercises', 'logger', 'history', 'add-exercise'].forEach(s => {
                document.getElementById(`screen-${s}`).classList.add('hidden');
            });
            document.getElementById(`screen-${screen}`).classList.remove('hidden');
            
            document.querySelectorAll('.fixed.bottom-0 button').forEach(btn => btn.classList.replace('text-blue-600', 'text-gray-400'));
            if(screen === 'categories' || screen === 'exercises' || screen === 'logger' || screen === 'add-exercise') {
                document.querySelectorAll('.fixed.bottom-0 button')[0].classList.replace('text-gray-400', 'text-blue-600');
            }
            if(screen === 'history') document.querySelectorAll('.fixed.bottom-0 button')[1].classList.replace('text-gray-400', 'text-blue-600');
        }

        function handleUserChange() {
            loadData();
            renderHistory();
            renderChart();
            if (!document.getElementById('screen-exercises').classList.contains('hidden')) {
                openCategory(document.getElementById('categoryTitle').textContent);
            }
        }

        function renderCategories() {
            const list = document.getElementById('categoryList');
            const dropdown = document.getElementById('newExCategory');
        
            list.innerHTML = categories.map(cat => `
                <div onclick='openCategory("${cat}")' class="p-4 flex justify-between items-center cursor-pointer active:bg-gray-50">
                    <span class="font-bold text-gray-800">${cat}</span>
                    <span class="text-gray-300">&rang;</span>
                </div>
            `).join('');
        
            dropdown.innerHTML = categories.map(cat => `
                <option value="${cat}">${cat}</option>
            `).join('');
        }
        
        function openCategory(category) {
            document.getElementById('categoryTitle').innerText = category;
            renderExerciseList(category);
            showScreen('exercises');
        }

     function renderExerciseList(category) {
            const list = document.getElementById('exerciseList');
            const user = document.getElementById('userToggle').value.toLowerCase();
            const showInactive = document.getElementById('showInactiveCheck').checked;
            
            const filtered = exercises.filter(ex => ex.category === category);
            
            const htmlOutput = filtered.map(ex => {
                // Find headers even if they are capitalized in the sheet
                const inactiveKey = Object.keys(ex).find(k => k.toLowerCase() === `inactive_${user}`);
                const readyKey = Object.keys(ex).find(k => k.toLowerCase() === `levelup_${user}`);

                // Trim spaces and check for "true"
                const isInactive = inactiveKey ? String(ex[inactiveKey]).trim().toLowerCase() === 'true' : false;
                const isReady = readyKey ? String(ex[readyKey]).trim().toLowerCase() === 'true' : false;
                
                if (isInactive && !showInactive) return '';

                const readyBadge = isReady ? `<span class="ml-2 text-[10px] bg-orange-100 text-orange-800 px-2 py-1 rounded-full font-bold uppercase tracking-wider">Up Next üöÄ</span>` : '';
                const inactiveBadge = isInactive ? `<span class="ml-2 text-[10px] bg-gray-200 text-gray-600 px-2 py-1 rounded-full font-bold uppercase tracking-wider">Inactive üí§</span>` : '';
                
                return `
                <div onclick='openLogger(${JSON.stringify(ex).replace(/'/g, "&apos;")})' class="p-4 flex justify-between items-center cursor-pointer active:bg-gray-50 ${isInactive ? 'opacity-50' : ''}">
                    <div class="flex items-center">
                        <span class="font-bold text-gray-800">${ex.name}</span>
                        ${readyBadge}
                        ${inactiveBadge}
                    </div>
                    <span class="text-gray-300">&rang;</span>
                </div>
                `;
            }).join('');

            list.innerHTML = htmlOutput || '<div class="p-4 text-center text-gray-400">No active exercises.</div>';
        }
        function renderHistory() {
            const user = document.getElementById('userToggle').value;
            const selectedExercise = document.getElementById('historyExerciseToggle').value;
            const list = document.getElementById('historyList');
            
            const filtered = historyData.filter(log => {
                const matchesUser = log.user_name === user;
                const matchesExercise = !selectedExercise || log.exercise_name === selectedExercise;
                return matchesUser && matchesExercise;
            });
            
            if (filtered.length === 0) return list.innerHTML = '<div class="p-4 text-center text-gray-400">No logs found.</div>';
            
            list.innerHTML = filtered.map(log => `
                <div class="p-4 flex justify-between items-center group">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-1 mr-4">
                            <span class="font-bold text-gray-800">${log.exercise_name}</span>
                            <span class="text-xs px-2 py-1 rounded bg-${log.user_name === 'Alex' ? 'green' : 'pink'}-100 text-${log.user_name === 'Alex' ? 'green' : 'pink'}-800 font-bold">${log.user_name}</span>
                        </div>
                        <div class="text-sm text-gray-600">${[log.sets ? log.sets+' Sets' : '', log.reps ? log.reps+' Reps' : '', log.weight ? log.weight+'kg' : '', log.time ? log.time+'s' : ''].filter(Boolean).join(' √ó ')}</div>
                        
                        <div class="text-xs mt-1 flex items-center space-x-2">
                            <span class="text-gray-400">${log.date}</span>
                            ${log.category ? `<span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">${log.category}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteLog('${log.id}')" class="text-red-400 hover:text-red-600 p-2 text-xl">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        function populateHistoryDropdown() {
            const dropdown = document.getElementById('historyExerciseToggle');
            const uniqueExercises = [...new Set(historyData.map(log => log.exercise_name))].sort();
            dropdown.innerHTML = '<option value="">Select an exercise for chart...</option>' + 
                uniqueExercises.map(ex => `<option value="${ex}">${ex}</option>`).join('');
        }

        function renderChart() {
            const user = document.getElementById('userToggle').value;
            const exerciseName = document.getElementById('historyExerciseToggle').value;
            const canvas = document.getElementById('progressChart');
            const container = document.getElementById('chartContainer');
            
            renderHistory();
            
            if (!exerciseName) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            const chartLogs = historyData.filter(log => log.exercise_name === exerciseName && log.user_name === user).reverse();
            const labels = chartLogs.map(log => log.date);
            const data = chartLogs.map(log => parseFloat(log.weight) || parseFloat(log.time) || 0);
            
            if (progressChartInstance) progressChartInstance.destroy();
            
            progressChartInstance = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: exerciseName,
                        data: data,
                        borderColor: user === 'Alex' ? '#10B981' : '#EC4899', 
                        backgroundColor: user === 'Alex' ? '#D1FAE5' : '#FCE7F3',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function openLogger(ex) {
            resetTimer();
            currentExercise = ex;
            document.getElementById('loggerTitle').innerText = ex.name;
            
            document.getElementById('loggerChartContainer').classList.add('hidden');
            document.getElementById('chartToggleIcon').style.transform = 'rotate(0deg)';
            
            const gif = document.getElementById('gifViewer');
            if(ex.gif_url) { gif.src = ex.gif_url; gif.classList.remove('hidden'); }
            else { gif.classList.add('hidden'); }

            const units = ex.units ? ex.units.toLowerCase() : "sets,reps,weight";
            const isCardio = ex.category === "Cardio";
            
            ['sets', 'reps', 'weight', 'time'].forEach(u => {
                const container = document.getElementById(`input-${u}`);
                container.classList.toggle('hidden', !units.includes(u));
                
                if (u === 'time') {
                    container.querySelector('label').innerText = isCardio ? "Time (minutes)" : "Time (seconds)";
                }
            });

            loadData();
            showScreen('logger');
        }

        function loadData() {
            if(!currentExercise) return;
            const user = document.getElementById('userToggle').value;
            const userLogs = historyData.filter(l => l.exercise_name === currentExercise.name && l.user_name === user);
            const last = userLogs[0];
            const units = currentExercise.units ? currentExercise.units.toLowerCase() : "";
        
            if(last) {
                document.getElementById('sets').value = last.sets || '';
                document.getElementById('reps').value = last.reps || '';
                document.getElementById('weight').value = last.weight || '';
                document.getElementById('time').value = last.time || '';
                
            let details = [
                last.sets ? last.sets+' Sets' : '', 
                last.reps ? last.reps+' Reps' : '', 
                last.weight ? last.weight+'kg' : '', 
                last.time ? (currentExercise.category === "Cardio" ? last.time+'m' : last.time+'s') : ''
            ].filter(Boolean).join(' √ó ');
        
            document.getElementById('lastSessionText').innerText = `${last.date}: ${details}`;
        
                let incDate = null;
                for(let i=0; i<userLogs.length-1; i++) {
                    let increased = false;
                    
                    if (units.includes('weight')) {
                        increased = parseFloat(userLogs[i].weight) > parseFloat(userLogs[i+1].weight);
                    } else if (units.includes('time')) {
                        increased = parseFloat(userLogs[i].time) > parseFloat(userLogs[i+1].time);
                    } else if (units.includes('reps')) {
                        increased = parseFloat(userLogs[i].reps) > parseFloat(userLogs[i+1].reps);
                    }
        
                    if(increased) { incDate = userLogs[i].date; break; }
                }
        
                const prText = document.getElementById('prText');
                if(incDate) { 
                    prText.classList.remove('hidden'); 
                    document.getElementById('increaseDate').innerText = incDate; 
                } else { 
                    prText.classList.add('hidden'); 
                }
            } else {
                ['sets', 'reps', 'weight', 'time'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('lastSessionText').innerText = "No previous data.";
                document.getElementById('prText').classList.add('hidden');
            }

            const userLower = user.toLowerCase();
            const readyKey = Object.keys(currentExercise).find(k => k.toLowerCase() === `levelup_${userLower}`);
            const inactiveKey = Object.keys(currentExercise).find(k => k.toLowerCase() === `inactive_${userLower}`);

            const isReady = readyKey ? String(currentExercise[readyKey]).trim().toLowerCase() === 'true' : false;
            const isInactive = inactiveKey ? String(currentExercise[inactiveKey]).trim().toLowerCase() === 'true' : false;

            document.getElementById('levelUpCheck').checked = isReady;
            document.getElementById('inactiveCheck').checked = isInactive;;

            const levelContainer = document.getElementById('levelUpContainer');
            if (isReady) levelContainer.classList.replace('border-transparent', 'border-blue-500');
            else levelContainer.classList.replace('border-blue-500', 'border-transparent');

            const inactiveContainer = document.getElementById('inactiveContainer');
            if (isInactive) inactiveContainer.classList.replace('border-transparent', 'border-gray-400');
            else inactiveContainer.classList.replace('border-gray-400', 'border-transparent');

            renderLoggerChart();
        }

        function toggleLoggerChart() {
            const container = document.getElementById('loggerChartContainer');
            const icon = document.getElementById('chartToggleIcon');
            
            if (icon.classList.contains('hidden')) return;

            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
                if (loggerChartInstance) loggerChartInstance.resize(); 
            } else {
                container.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function renderLoggerChart() {
            if (!currentExercise) return;
            const user = document.getElementById('userToggle').value;
            const canvas = document.getElementById('loggerChart');
            const icon = document.getElementById('chartToggleIcon');
            
            const chartLogs = historyData.filter(log => log.exercise_name === currentExercise.name && log.user_name === user).reverse();
            
            if (chartLogs.length < 2) {
                icon.classList.add('hidden');
                return;
            }
            
            icon.classList.remove('hidden');
            const labels = chartLogs.map(log => log.date);
            const data = chartLogs.map(log => parseFloat(log.weight) || parseFloat(log.time) || parseFloat(log.reps) || 0);
            
            if (loggerChartInstance) loggerChartInstance.destroy();
            
            loggerChartInstance = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: currentExercise.name,
                        data: data,
                        borderColor: user === 'Alex' ? '#10B981' : '#EC4899', 
                        backgroundColor: user === 'Alex' ? '#D1FAE5' : '#FCE7F3',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, ticks: { maxTicksLimit: 5 } }, 
                        y: { display: true, ticks: { maxTicksLimit: 4 } }
                    }
                }
            });
        }

function toggleTimer() {
            const btn = document.getElementById('timerBtn');
            const resetBtn = document.getElementById('resetTimerBtn');
            const display = document.getElementById('countdownDisplay');
            const isCardio = currentExercise.category === "Cardio";
            
            const updateDisplay = () => {
                const m = Math.floor(countdownValue / 60);
                const s = countdownValue % 60;
                display.innerText = (isCardio || m > 0) ? `${m}:${s.toString().padStart(2, '0')}` : countdownValue;
            };

            if (timerInterval) {
                // Timer is running -> Pause it
                clearInterval(timerInterval);
                timerInterval = null;
                btn.innerText = "Resume";
                btn.className = "text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase w-16 text-center transition-colors bg-yellow-500";
            } else {
                // Timer is paused or stopped -> Start/Resume it
                if (countdownValue <= 0 || display.classList.contains('hidden')) {
                    let rawValue = parseInt(document.getElementById('time').value) || 0;
                    countdownValue = isCardio ? rawValue * 60 : rawValue; 
                    if(countdownValue <= 0) return;   
                    
                    display.classList.remove('hidden');
                    display.classList.remove('text-red-500');
                    display.classList.add('text-orange-500');
                    resetBtn.classList.remove('hidden');
                }
                
                updateDisplay();
                btn.innerText = "Pause";
                btn.className = "text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase w-16 text-center transition-colors bg-red-500";

                timerInterval = setInterval(() => {
                    countdownValue--;
                    updateDisplay();
                    
                    if(countdownValue <= 5) display.classList.replace('text-orange-500', 'text-red-500');
                    
                    if(countdownValue <= 0) {
                        resetTimer();
                        dingSound.play().catch(e => console.log("Audio play prevented by browser"));
                    }
                }, 1000);
            }
        }

        function resetTimer() {
            const btn = document.getElementById('timerBtn');
            const resetBtn = document.getElementById('resetTimerBtn');
            const display = document.getElementById('countdownDisplay');
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            countdownValue = 0;
            display.classList.add('hidden');
            
            btn.innerText = "Start";
            btn.className = "text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase w-16 text-center transition-colors bg-green-500";
            resetBtn.classList.add('hidden');
        }
        
        async function submitWorkout() {
            const btn = document.getElementById('submitBtn');
            const user = document.getElementById('userToggle').value;
            const currentDate = new Date().toLocaleDateString('en-GB');
            const userLogs = historyData.filter(l => l.exercise_name === currentExercise.name && l.user_name === user);
    
            const alreadyLogged = userLogs.some(l => l.date === currentDate);
            if (alreadyLogged) {
                const proceed = confirm(`You already logged ${currentExercise.name} today. Are you sure you want to log it again?`);
                if (!proceed) return; 
            }
    
            btn.innerText = "Saving...";
            btn.disabled = true;
        
            const weightVal = parseFloat(document.getElementById('weight').value) || 0;
            const repsVal = parseFloat(document.getElementById('reps').value) || 0;
            const timeVal = parseFloat(document.getElementById('time').value) || 0;
            
            const units = currentExercise.units ? currentExercise.units.toLowerCase() : "";
        
            const bestWeight = Math.max(0, ...userLogs.map(l => parseFloat(l.weight) || 0));
            const bestReps = Math.max(0, ...userLogs.map(l => parseFloat(l.reps) || 0));
            const bestTime = Math.max(0, ...userLogs.map(l => parseFloat(l.time) || 0));
        
            let isPR = false;
        
            if (units.includes('weight') && weightVal > 0) {
                isPR = weightVal > bestWeight && bestWeight > 0;
            } else if (units.includes('time') && timeVal > 0) {
                isPR = timeVal > bestTime && bestTime > 0;
            } else if (units.includes('reps') && repsVal > 0) {
                isPR = repsVal > bestReps && bestReps > 0;
            }
        
            const log = {
                id: crypto.randomUUID(),
                exercise_name: currentExercise.name,
                category: currentExercise.category,
                user_name: user,
                date: new Date().toLocaleDateString('en-GB'), 
                sets: document.getElementById('sets').value,
                reps: document.getElementById('reps').value,
                weight: document.getElementById('weight').value,
                time: document.getElementById('time').value
            };
        
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [log] })
                });
                
                if (isPR) {
                    confetti({ 
                        particleCount: 150, 
                        spread: 70, 
                        origin: { y: 0.6 },
                        colors: user === 'Alex' ? ['#10B981', '#ffffff'] : ['#EC4899', '#ffffff'] 
                    });

                    const userLower = user.toLowerCase();
                    const levelUpColumn = `levelup_${userLower}`;
                    
                    try {
                        await fetch(`${API_URL}/id/${currentExercise.id}?sheet=Exercises`, {
                            method: 'PATCH',
                            headers: { 
                                'Accept': 'application/json',
                                'Content-Type': 'application/json' 
                            },
                            body: JSON.stringify({ data: { [levelUpColumn]: "false" } })
                        });
                        
                        await fetchExercises(); 
                    } catch (err) {
                        console.error("Auto-reset failed:", err);
                    }

                    await new Promise(r => setTimeout(r, 2000));
                }
        
                await fetchHistory(); 
                loadData();
            } catch (err) { 
                alert("Failed to save log."); 
            }
        
            btn.innerText = "Log Workout";
            btn.disabled = false;
        }
        
        async function deleteLog(logId) {
            if (!confirm("Are you sure you want to delete this log?")) return;

            try {
                const res = await fetch(`${API_URL}/id/${logId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (res.ok) {
                    await fetchHistory();
                    alert("Log deleted successfully.");
                }
            } catch (err) {
                alert("Failed to delete log.");
            }
        }

        async function updateExerciseState(type, isChecked) {
            const user = document.getElementById('userToggle').value.toLowerCase();
            const column = `${type}_${user}`; 
            
            const containerId = type === 'levelup' ? 'levelUpContainer' : 'inactiveContainer';
            const activeColor = type === 'levelup' ? 'border-blue-500' : 'border-gray-400';
            const container = document.getElementById(containerId);
            
            if (isChecked) {
                container.classList.replace('border-transparent', activeColor);
            } else {
                container.classList.replace(activeColor, 'border-transparent');
            }

            try {
                await fetch(`${API_URL}/id/${currentExercise.id}?sheet=Exercises`, {
                    method: 'PATCH',
                    headers: { 
                        'Accept': 'application/json',
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ data: { [column]: isChecked ? "true" : "false" } })
                });
                
                await fetchExercises();
                if (currentExercise && currentExercise.category) {
                    renderExerciseList(currentExercise.category);
                }
            } catch (err) {
                console.error("Failed to sync with Google Sheets:", err);
            }
        }

        function toggleLevelUp() {
            updateExerciseState('levelup', document.getElementById('levelUpCheck').checked);
        }

        function toggleInactive() {
            updateExerciseState('inactive', document.getElementById('inactiveCheck').checked);
        }

        async function saveNewExercise() {
            const btn = document.getElementById('addExBtn');
            const name = document.getElementById('newExName').value;
            const category = document.getElementById('newExCategory').value;
            const selectedUnits = Array.from(document.querySelectorAll('.unit-check:checked')).map(cb => cb.value).join(',');

            if (!name) return alert("Please enter a name.");

            btn.innerText = "Adding...";
            btn.disabled = true;

            const newExercise = {
                id: crypto.randomUUID(),
                name: name,
                category: category,
                units: selectedUnits,
                gif_url: ""
            };

            try {
                const res = await fetch(`${API_URL}?sheet=Exercises`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [newExercise] })
                });

                if (res.ok) {
                    alert(`${name} added!`);
                    document.getElementById('newExName').value = ""; 
                    await fetchExercises(); 
                    renderCategories(); 
                    showScreen('categories');
                }
            } catch (err) {
                alert("Error adding exercise.");
            }

            btn.innerText = "Save to Exercises";
            btn.disabled = false;
        }

        init(); 
    </script>
</body>
</html>
